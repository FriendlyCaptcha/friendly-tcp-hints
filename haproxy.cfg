global
  log /dev/log local0
  maxconn 20000

defaults
  log     global
  mode    http
  option  httplog
  timeout client  60s
  timeout connect 5s
  timeout server  60s

# SPOA connection (your agent listens on 127.0.0.1:9000)
backend spoe_p0f
  mode tcp
  server spoa 127.0.0.1:9000 maxconn 100

# Public HTTP endpoint
frontend fe_http
  bind :80
  mode http

  filter spoe engine p0f config /etc/haproxy/p0f.spop

    # Track clients by IP and store stats
    stick-table type ip size 1m expire 10m store http_req_cnt,http_req_rate(10m),conn_rate(10m),conn_cur,bytes_in_rate(10m),bytes_out_rate(10m)

    # Track connection by source IP
    tcp-request connection track-sc0 src

    # For http_req_cnt / http_req_rate)
    http-request track-sc0 src

    # end use ip in case we want it: X-Forwarded-For: ip
    # option forwardfor if-none

    # original ip for debugging
    # http-request set-header X-TCP-Client-IP %[src]

    # number of simultaneously active connections ATM
    http-request set-header X-TCP-CurSimCon  %[sc_conn_cur(0)]
    
    # total registered within 10 minutes (see expire 10m)
    http-request set-header X-TCP-TotalCon   %[sc_http_req_cnt(0)]
    
    # http requests rate 10m per IP 
    http-request set-header X-TCP-ReqRate10m   %[sc_http_req_rate(0)]
    
    # connections rate 10m per IP 
    http-request set-header X-TCP-ConnRate10m  %[sc_conn_rate(0)]
    
    # bytes in (expires 10m)
    http-request set-header X-TCP-BytesInRate  %[sc_bytes_in_rate(0)]
    
    # bytes out (expires 10m)
    http-request set-header X-TCP-BytesOutRate %[sc_bytes_out_rate(0)]

  # Trigger SPOE once per connection (first HTTP request only)
  http-request send-spoe-group p0f p0f-group if !{ var(sess.p0f.os) -m found }

  # Force SPOE while debugging (remove the condition temporarily)
  http-request send-spoe-group p0f p0f-group

  http-request set-header X-P0f-OS          %[var(sess.p0f.os)]          if { var(sess.p0f.os) -m found }
  http-request set-header X-P0f-Link        %[var(sess.p0f.link)]        if { var(sess.p0f.link) -m found }
  http-request set-header X-P0f-Dist        %[var(sess.p0f.dist)]        if { var(sess.p0f.dist) -m found }
  http-request set-header X-P0f-Uptime      %[var(sess.p0f.uptime)]      if { var(sess.p0f.uptime) -m found }
  http-request set-header X-P0f-NAT         %[var(sess.p0f.nat)]         if { var(sess.p0f.nat) -m found }

  http-request set-header X-P0f-MTU         %[var(sess.p0f.link_mtu)]         if { var(sess.p0f.link_mtu) -m found }
  http-request set-header X-P0f-MSS         %[var(sess.p0f.link_mss)]         if { var(sess.p0f.link_mss) -m found }
  http-request set-header X-P0f-MatchQ      %[var(sess.p0f.os_match_q)]  if { var(sess.p0f.os_match_q) -m found }

  http-request set-header X-P0f-BadSW       %[var(sess.p0f.bad_sw)]      if { var(sess.p0f.bad_sw) -m found }

  http-request set-header X-P0f-HTTP-Name   %[var(sess.p0f.http_name)]   if { var(sess.p0f.http_name) -m found }
  http-request set-header X-P0f-HTTP-Ver    %[var(sess.p0f.http_flavor)] if { var(sess.p0f.http_flavor) -m found }
  http-request set-header X-P0f-Lang        %[var(sess.p0f.language)]    if { var(sess.p0f.language) -m found }

  http-request set-header X-P0f-FirstSeen   %[var(sess.p0f.first_seen)]  if { var(sess.p0f.first_seen) -m found }
  http-request set-header X-P0f-LastSeen    %[var(sess.p0f.last_seen)]   if { var(sess.p0f.last_seen) -m found }
  http-request set-header X-P0f-LastNat     %[var(sess.p0f.last_nat)]    if { var(sess.p0f.last_nat) -m found }
  http-request set-header X-P0f-LastChg     %[var(sess.p0f.last_chg)]    if { var(sess.p0f.last_chg) -m found }
  http-request set-header X-P0f-Conns       %[var(sess.p0f.total_conn)]  if { var(sess.p0f.total_conn) -m found }
  http-request set-header X-P0f-UpModDays   %[var(sess.p0f.up_mod_days)] if { var(sess.p0f.up_mod_days) -m found }

  default_backend app

backend app
  mode http
  server app1 127.0.0.1:8080 check

